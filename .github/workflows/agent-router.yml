name: agent-router
on:
  pull_request:
    types: [opened, synchronize, labeled]

jobs:
  route:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm ci

      # 🚀 Lance le pipeline uniquement si le label est présent
      - name: Generate weekly
        if: contains(join(toJson(github.event.pull_request.labels)), 'run:portfolio')
        run: npm run run:weekly

      # 🖼️ Résumé visuel dans l'onglet "Summary" du run
      - name: Build Job Summary (visual)
        if: contains(join(toJson(github.event.pull_request.labels)), 'run:portfolio')
        shell: bash
        run: |
          node -e "const fs=require('fs');
          const p=JSON.parse(fs.readFileSync('data/portfolio.target.json','utf8'));
          const s=JSON.parse(fs.readFileSync('data/weekly-summary.json','utf8'));
          const rows=(p.target||[]).map(t=>`| ${t.symbol} | ${(t.weight*100).toFixed(2)}% |`).join('\n');
          const sectors=(s.summary||[]).map(x=>`- **${x.sector}**: ${x.top.join(', ')}`).join('\n');
          const md = `### Allocation cible\n\n**Statut risque:** **${p.riskStatus}**  \n\n| Symbole | Poids |\n|---|---|\n${rows}\n\n### Picks par secteur\n${sectors}\n`;
          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, md);"

      # 💬 Commentaire automatique sur la PR (optionnel mais pratique)
      - name: Comment PR with summary
        if: contains(join(toJson(github.event.pull_request.labels)), 'run:portfolio')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const p = JSON.parse(fs.readFileSync('data/portfolio.target.json','utf8'));
            const s = JSON.parse(fs.readFileSync('data/weekly-summary.json','utf8'));
            const rows = (p.target||[]).map(t=>`| ${t.symbol} | ${(t.weight*100).toFixed(2)}% |`).join('\n');
            const sectors=(s.summary||[]).map(x=>`- **${x.sector}**: ${x.top.join(', ')}`).join('\n');
            const body = [
              '### 🔎 Résumé du cycle',
              `**Risque:** **${p.riskStatus}**`,
              '',
              '| Symbole | Poids |',
              '|---|---|',
              rows,
              '',
              '#### Picks par secteur',
              sectors
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });

      # 📦 Artefacts téléchargeables
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-artifacts
          path: |
            data/weekly-summary.json
            data/portfolio.target.json
            data/recos.jsonl
            data/exec.log.jsonl
