name: agent-router
on:
  pull_request:
    types: [opened, synchronize, labeled]

jobs:
  route:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      # ðŸ§  Lancement du cycle hebdo uniquement si le label est prÃ©sent
      - name: Generate weekly report
        if: contains(join(toJson(github.event.pull_request.labels)), 'run:portfolio')
        run: npm run run:weekly

      # ðŸ–¼ï¸ Ajout dâ€™un rÃ©sumÃ© visuel dans lâ€™onglet "Summary"
      - name: Visual summary
        if: contains(join(toJson(github.event.pull_request.labels)), 'run:portfolio')
        shell: bash
        run: |
          node -e "
          const fs=require('fs');
          const portfolio=JSON.parse(fs.readFileSync('data/portfolio.target.json','utf8'));
          const summary=JSON.parse(fs.readFileSync('data/weekly-summary.json','utf8'));
          const tableRows=(portfolio.target||[]).map(t=>`| ${t.symbol} | ${(t.weight*100).toFixed(2)}% |`).join('\\n');
          const sectors=(summary.summary||[]).map(x=>`- **${x.sector}**: ${x.top.join(', ')}`).join('\\n');
          const md = [
            '## ðŸ“Š Portfolio Weekly Summary',
            '',
            `**Risque:** **${portfolio.riskStatus}**`,
            '',
            '| Symbole | Poids |',
            '|---|---|',
            tableRows,
            '',
            '### Picks par secteur',
            sectors
          ].join('\\n');
          fs.writeFileSync(process.env.GITHUB_STEP_SUMMARY, md);
          "

      # ðŸ’¬ (Optionnel) Commentaire automatique sur la PR
      - name: Comment PR
        if: contains(join(toJson(github.event.pull_request.labels)), 'run:portfolio')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const portfolio = JSON.parse(fs.readFileSync('data/portfolio.target.json','utf8'));
            const summary = JSON.parse(fs.readFileSync('data/weekly-summary.json','utf8'));
            const rows = (portfolio.target||[]).map(t=>`| ${t.symbol} | ${(t.weight*100).toFixed(2)}% |`).join('\n');
            const sectors = (summary.summary||[]).map(x=>`- **${x.sector}**: ${x.top.join(', ')}`).join('\n');
            const body = [
              '### ðŸ“Š Rapport Hebdo',
              `**Risque:** **${portfolio.riskStatus}**`,
              '',
              '| Symbole | Poids |',
              '|---|---|',
              rows,
              '',
              '### Picks par secteur',
              sectors
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });

      # ðŸ“¦ Artefacts (pour tÃ©lÃ©charger les fichiers JSON)
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-artifacts
          path: |
            data/weekly-summary.json
            data/portfolio.target.json
            data/recos.jsonl
            data/exec.log.jsonl
